# .github/workflows/build-rainonday-apk.yml
name: Build RainOnDay APK

on:
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'Build Profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production

jobs:
  build-apk:
    name: Build RainOnDay APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ› ï¸ EAS CLI ì„¤ì¹˜
        run: npm install -g @expo/eas-cli@latest

      - name: ğŸ” Expo ì¸ì¦ í™•ì¸
        run: eas whoami
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸš€ APK ë¹Œë“œ ì‹¤í–‰
        run: |
          echo "ğŸ”¨ ë¹Œë“œ í”„ë¡œí•„: ${{ github.event.inputs.build_profile || 'preview' }}"
          eas build --platform android --profile ${{ github.event.inputs.build_profile || 'preview' }} --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“± APK íŒŒì¼ ì²˜ë¦¬
        run: |
          APK_FILE=$(find . -name "*.apk" -type f | head -1)
          if [ -n "$APK_FILE" ]; then
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            PROFILE="${{ github.event.inputs.build_profile || 'preview' }}"
            NEW_NAME="RainOnDay_${PROFILE}_${TIMESTAMP}.apk"
            mv "$APK_FILE" "$NEW_NAME"
            echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV
            echo "âœ… APK íŒŒì¼ëª…: $NEW_NAME"
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

      - name: â¬†ï¸ APK Artifacts ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: rainonday-apk-${{ github.run_number }}
          path: ${{ env.APK_NAME }}
          retention-days: 30
