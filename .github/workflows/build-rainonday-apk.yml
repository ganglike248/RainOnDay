# .github/workflows/build-rainonday-apk.yml
name: Build RainOnDay APK

on:
  # ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'Build Profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - development
          - preview
          - production

  # main ë¸Œëžœì¹˜ì— push ì‹œ ìžë™ ì‹¤í–‰ (ì„ íƒì‚¬í•­)
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build-apk:
    name: Build RainOnDay APK
    runs-on: ubuntu-latest
    
    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # Node.js ì„¤ì • (í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë²„ì „ì— ë§žì¶¤)
      - name: ðŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      # Firebase ì„¤ì • íŒŒì¼ ìƒì„± (ì¶”ê°€ëœ ë¶€ë¶„)
      - name: ðŸ” Firebase ì„¤ì • íŒŒì¼ ìƒì„±
        run: |
          if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
            echo "âœ… Firebase ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘..."
            echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 -d > google-services.json
            echo "âœ… Firebase ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ"
            ls -la google-services.json
          else
            echo "âš ï¸ GOOGLE_SERVICES_JSON Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            echo "ë¡œì»¬ ì•Œë¦¼ë§Œ ì‚¬ìš©í•˜ëŠ” ë¹Œë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤"
          fi

      # EAS CLI ì„¤ì¹˜
      - name: ðŸ› ï¸ EAS CLI ì„¤ì¹˜
        run: |
          echo "ðŸ”§ NPM ì„¤ì • ì´ˆê¸°í™”"
          npm config set registry https://registry.npmjs.org/
          npm config delete proxy || true
          npm config delete https-proxy || true
          npm cache clean --force
          
          echo "ðŸ“¦ EAS CLI ì„¤ì¹˜ ì‹œë„"
          # ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì„¤ì¹˜ ì‹œë„
          npm install -g @expo/eas-cli@latest || \
          npm install -g @expo/eas-cli@16.17.3 || \
          npm install -g eas-cli@latest || \
          { echo "NPM ì„¤ì¹˜ ì‹¤íŒ¨, Yarnìœ¼ë¡œ ì‹œë„"; npm install -g yarn && yarn global add @expo/eas-cli@latest; }
          
          echo "âœ… EAS CLI ë²„ì „ í™•ì¸"
          eas --version || npx @expo/eas-cli@latest --version

      # Expo ì¸ì¦ í™•ì¸
      - name: ðŸ” Expo ì¸ì¦ í™•ì¸
        run: eas whoami
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # ë¹Œë“œ í”„ë¡œí•„ë³„ APK ë¹Œë“œ
      - name: ðŸš€ APK ë¹Œë“œ ì‹¤í–‰
        run: |
          echo "ðŸ”¨ ë¹Œë“œ í”„ë¡œí•„: ${{ github.event.inputs.build_profile || 'preview' }}"
          
          if [ "${{ github.event.inputs.build_profile }}" = "development" ]; then
            eas build --platform android --profile development --non-interactive
          elif [ "${{ github.event.inputs.build_profile }}" = "production" ]; then
            eas build --platform android --profile production --non-interactive
          else
            eas build --platform android --profile preview --non-interactive
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # ë¹Œë“œ í›„ ë¯¼ê°í•œ íŒŒì¼ ì •ë¦¬ (ì¶”ê°€ëœ ë¶€ë¶„)
      - name: ðŸ§¹ ë¯¼ê°í•œ íŒŒì¼ ì •ë¦¬
        run: |
          echo "ðŸ§¹ Firebase ì„¤ì • íŒŒì¼ ì •ë¦¬ ì¤‘..."
          rm -f google-services.json
          rm -f service-account-*.json
          echo "âœ… ë¯¼ê°í•œ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"

      # ë¹Œë“œëœ APK íŒŒì¼ ì°¾ê¸° ë° ì´ë¦„ ë³€ê²½
      - name: ðŸ“± APK íŒŒì¼ ì²˜ë¦¬
        run: |
          APK_FILE=$(find . -name "*.apk" -type f | head -1)
          if [ -n "$APK_FILE" ]; then
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            PROFILE="${{ github.event.inputs.build_profile || 'preview' }}"
            NEW_NAME="RainOnDay_${PROFILE}_${TIMESTAMP}.apk"
            mv "$APK_FILE" "$NEW_NAME"
            echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV
            echo "âœ… APK íŒŒì¼ëª…: $NEW_NAME"
            
            # APK íŒŒì¼ í¬ê¸° í™•ì¸
            FILE_SIZE=$(ls -lh "$NEW_NAME" | awk '{print $5}')
            echo "ðŸ“ APK í¬ê¸°: $FILE_SIZE"
            echo "APK_SIZE=$FILE_SIZE" >> $GITHUB_ENV
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

      # APKë¥¼ GitHub Artifactsë¡œ ì—…ë¡œë“œ
      - name: â¬†ï¸ APK Artifacts ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: rainonday-apk-${{ github.run_number }}
          path: ${{ env.APK_NAME }}
          retention-days: 30

      # ë¹Œë“œ ì™„ë£Œ ìš”ì•½
      - name: ðŸ“Š ë¹Œë“œ ìš”ì•½
        run: |
          echo "## ðŸŽ‰ ë¹„ì˜¨ë°ì´ APK ë¹Œë“œ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± ë¹Œë“œ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ì•± ì´ë¦„**: RainOnDay (ë¹„ì˜¨ë°ì´)" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ í”„ë¡œí•„**: ${{ github.event.inputs.build_profile || 'preview' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APK íŒŒì¼**: ${{ env.APK_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **íŒŒì¼ í¬ê¸°**: ${{ env.APK_SIZE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ ë²ˆí˜¸**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ë‹¤ìš´ë¡œë“œ ë°©ë²•" >> $GITHUB_STEP_SUMMARY
          echo "1. Actions íƒ­ìœ¼ë¡œ ì´ë™" >> $GITHUB_STEP_SUMMARY
          echo "2. ì´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì„ ì„ íƒ" >> $GITHUB_STEP_SUMMARY
          echo "3. í•˜ë‹¨ Artifacts ì„¹ì…˜ì—ì„œ APK ë‹¤ìš´ë¡œë“œ" >> $GITHUB_STEP_SUMMARY
