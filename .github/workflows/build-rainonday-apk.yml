# .github/workflows/build-rainonday-apk.yml
name: Build RainOnDay APK

on:
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'Build Profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - development
          - preview
          - production

  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build-apk:
    name: Build RainOnDay APK (Local Build)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Java ì„¤ì • ì¶”ê°€ (Android ë¹Œë“œìš©)
      - name: â˜• Java ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Android SDK ì„¤ì •
      - name: ðŸ“± Android SDK ì„¤ì •
        uses: android-actions/setup-android@v3

      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      # Firebase ì„¤ì • íŒŒì¼ ìƒì„±
      - name: ðŸ” Firebase ì„¤ì • íŒŒì¼ ìƒì„±
        run: |
          if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
            echo "âœ… Firebase ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘..."
            echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 -d > google-services.json
            echo "âœ… Firebase ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ"
          else
            echo "âš ï¸ GOOGLE_SERVICES_JSON Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          fi

      - name: ðŸ› ï¸ EAS CLI ì„¤ì¹˜
        run: |
          echo "ðŸ”§ NPM ì„¤ì • ì´ˆê¸°í™”"
          npm config set registry https://registry.npmjs.org/
          npm config delete proxy || true
          npm config delete https-proxy || true
          npm cache clean --force
          
          echo "ðŸ“¦ EAS CLI ì„¤ì¹˜ ì‹œë„"
          # ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì„¤ì¹˜ ì‹œë„
          npm install -g @expo/eas-cli@latest || \
          npm install -g @expo/eas-cli@16.17.3 || \
          npm install -g eas-cli@latest || \
          { echo "NPM ì„¤ì¹˜ ì‹¤íŒ¨, Yarnìœ¼ë¡œ ì‹œë„"; npm install -g yarn && yarn global add @expo/eas-cli@latest; }
          
          echo "âœ… EAS CLI ë²„ì „ í™•ì¸"
          eas --version || npx @expo/eas-cli@latest --version

      - name: ðŸ” Expo ì¸ì¦ í™•ì¸
        run: eas whoami
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # ë¡œì»¬ ë¹Œë“œ ì‹¤í–‰ (í•µì‹¬ ìˆ˜ì •ì‚¬í•­)
      - name: ðŸš€ APK ë¡œì»¬ ë¹Œë“œ ì‹¤í–‰
        run: |
          echo "ðŸ”¨ ë¡œì»¬ ë¹Œë“œ í”„ë¡œí•„: ${{ github.event.inputs.build_profile || 'preview' }}"
          echo "ðŸ  GitHub Actions í™˜ê²½ì—ì„œ ì§ì ‘ ë¹Œë“œ ì‹¤í–‰"
          
          if [ "${{ github.event.inputs.build_profile }}" = "development" ]; then
            eas build --platform android --profile development --local --non-interactive
          elif [ "${{ github.event.inputs.build_profile }}" = "production" ]; then
            eas build --platform android --profile production --local --non-interactive
          else
            eas build --platform android --profile preview --local --non-interactive
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # ë¹Œë“œ í›„ ë¯¼ê°í•œ íŒŒì¼ ì •ë¦¬
      - name: ðŸ§¹ ë¯¼ê°í•œ íŒŒì¼ ì •ë¦¬
        run: |
          rm -f google-services.json
          rm -f service-account-*.json

      - name: ðŸ“± APK íŒŒì¼ ì²˜ë¦¬
        run: |
          APK_FILE=$(find . -name "*.apk" -type f | head -1)
          if [ -n "$APK_FILE" ]; then
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            PROFILE="${{ github.event.inputs.build_profile || 'preview' }}"
            NEW_NAME="RainOnDay_LOCAL_${PROFILE}_${TIMESTAMP}.apk"
            mv "$APK_FILE" "$NEW_NAME"
            echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV
            echo "âœ… ë¡œì»¬ ë¹Œë“œ APK: $NEW_NAME"
            
            FILE_SIZE=$(ls -lh "$NEW_NAME" | awk '{print $5}')
            echo "ðŸ“ APK í¬ê¸°: $FILE_SIZE"
            echo "APK_SIZE=$FILE_SIZE" >> $GITHUB_ENV
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

      - name: â¬†ï¸ APK Artifacts ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: rainonday-local-apk-${{ github.run_number }}
          path: ${{ env.APK_NAME }}
          retention-days: 30

      - name: ðŸ“Š ë¹Œë“œ ìš”ì•½
        run: |
          echo "## ðŸŽ‰ ë¹„ì˜¨ë°ì´ ë¡œì»¬ ë¹Œë“œ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ  ë¡œì»¬ ë¹Œë“œ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ ë°©ì‹**: GitHub Actions ë¡œì»¬ ë¹Œë“œ (ëŒ€ê¸° ì‹œê°„ ì—†ìŒ)" >> $GITHUB_STEP_SUMMARY
          echo "- **ì•± ì´ë¦„**: RainOnDay (ë¹„ì˜¨ë°ì´)" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ í”„ë¡œí•„**: ${{ github.event.inputs.build_profile || 'preview' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APK íŒŒì¼**: ${{ env.APK_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **íŒŒì¼ í¬ê¸°**: ${{ env.APK_SIZE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ ë²ˆí˜¸**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ ë¹Œë“œ íŠ¹ì§•" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Expo ë¹Œë“œ ëŒ€ê¸° ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Actionsì—ì„œ ì§ì ‘ ë¹Œë“œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Firebase í‘¸ì‹œ ì•Œë¦¼ ì§€ì›" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ë¹ ë¥¸ ë¹Œë“œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
