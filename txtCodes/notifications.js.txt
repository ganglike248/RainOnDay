// utils/notifications.js
import * as Notifications from 'expo-notifications';
import * as Device from 'expo-device';
import Constants from 'expo-constants';
import { Platform, Alert } from 'react-native';
import NetInfo from '@react-native-community/netinfo'; // ìˆ˜ì •ëœ import

Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowBanner: true,
    shouldShowList: true,
    shouldPlaySound: true,
    shouldSetBadge: false,
  }),
});

export const registerForPushNotificationsAsync = async (retryCount = 0) => {
  const MAX_RETRIES = 3;
  let token;

  try {
    if (!Device.isDevice) {
      Alert.alert('ì•Œë¦¼ ë“±ë¡ ì‹¤íŒ¨', 'ì‹¤ì œ ê¸°ê¸°ì—ì„œë§Œ í‘¸ì‹œ ì•Œë¦¼ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      return null;
    }

    // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸
    const networkAvailable = await checkNetworkAndRetry();
    if (!networkAvailable) {
      return null;
    }

    // ë” ìƒì„¸í•œ ë””ë²„ê¹… ì •ë³´
    console.log('=== ìƒì„¸ EAS ë””ë²„ê¹… ===');
    console.log('Constants.expoConfig:', JSON.stringify(Constants.expoConfig, null, 2));
    console.log('Constants.easConfig:', JSON.stringify(Constants.easConfig, null, 2));
    console.log('Constants.manifest:', JSON.stringify(Constants.manifest, null, 2));
    console.log('Constants.manifest2:', JSON.stringify(Constants.manifest2, null, 2));

    // ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ í”„ë¡œì íŠ¸ ID í™•ì¸
    const projectId =
      Constants.expoConfig?.extra?.eas?.projectId ||
      Constants.easConfig?.projectId ||
      Constants.manifest?.extra?.eas?.projectId ||
      Constants.manifest2?.extra?.eas?.projectId ||
      'ff8a3b71-7f94-41f0-9b5d-34df9484f5fc'; // í•˜ë“œì½”ë”©ëœ ë°±ì—…ê°’

    console.log('ìµœì¢… í”„ë¡œì íŠ¸ ID:', projectId);
    console.log(`í‘¸ì‹œ í† í° ìƒì„± ì‹œë„ (${retryCount + 1}/${MAX_RETRIES + 1})`);
    console.log('========================');

    if (!projectId) {
      console.error('EAS í”„ë¡œì íŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      Alert.alert('ì„¤ì • ì˜¤ë¥˜', 'EAS í”„ë¡œì íŠ¸ ì„¤ì •ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.');
      return null;
    }

    // Android ì•Œë¦¼ ì±„ë„ ì„¤ì •
    if (Platform.OS === 'android') {
      await Notifications.setNotificationChannelAsync('default', {
        name: 'default',
        importance: Notifications.AndroidImportance.MAX,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: '#FF231F7C',
      });
    }

    // ê¶Œí•œ í™•ì¸
    const { status: existingStatus } = await Notifications.getPermissionsAsync();
    let finalStatus = existingStatus;

    console.log('í˜„ì¬ ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ:', existingStatus);

    if (existingStatus !== 'granted') {
      const { status } = await Notifications.requestPermissionsAsync();
      finalStatus = status;
      console.log('ê¶Œí•œ ìš”ì²­ í›„ ìƒíƒœ:', status);
    }

    if (finalStatus !== 'granted') {
      Alert.alert('ê¶Œí•œ í•„ìš”', 'ì„¤ì •ì—ì„œ ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
      return null;
    }

    // í‘¸ì‹œ í† í° ìƒì„± (íƒ€ì„ì•„ì›ƒê³¼ í•¨ê»˜)
    console.log('Firebase ê¸°ë°˜ í‘¸ì‹œ í† í° ìƒì„± ì‹œë„:', projectId);

    const tokenData = await Promise.race([
      Notifications.getExpoPushTokenAsync({
        projectId: projectId,
      }),
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('í‘¸ì‹œ í† í° ìƒì„± íƒ€ì„ì•„ì›ƒ')), 15000)
      )
    ]);

    token = tokenData.data;
    console.log('í‘¸ì‹œ í† í° ìƒì„± ì„±ê³µ:', token);

    Alert.alert('ì•Œë¦¼ ë“±ë¡ ì„±ê³µ', 'Firebase ê¸°ë°˜ í‘¸ì‹œ ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    return token;

  } catch (error) {
    console.error(`í‘¸ì‹œ ì•Œë¦¼ ë“±ë¡ ì˜¤ë¥˜ (ì‹œë„ ${retryCount + 1}):`, error);

    // ì¬ì‹œë„ ê°€ëŠ¥í•œ ì—ëŸ¬ì¸ì§€ í™•ì¸
    const isRetryableError =
      error.message.includes('network') ||
      error.message.includes('fetch') ||
      error.message.includes('timeout') ||
      error.message.includes('Firebase') ||
      error.message.includes('ENOTFOUND') ||
      error.message.includes('ETIMEDOUT') ||
      error.message.includes('connection');

    if (isRetryableError && retryCount < MAX_RETRIES) {
      console.log(`${(retryCount + 1) * 2}ì´ˆ í›„ ì¬ì‹œë„...`);

      // ì§€ìˆ˜ ë°±ì˜¤í”„: 2ì´ˆ, 4ì´ˆ, 6ì´ˆ ëŒ€ê¸°
      await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 2000));

      return await registerForPushNotificationsAsync(retryCount + 1);
    }

    // ì—ëŸ¬ ì¢…ë¥˜ë³„ ë©”ì‹œì§€ ì²˜ë¦¬
    if (error.message.includes('FirebaseApp') || error.message.includes('google-services')) {
      Alert.alert(
        'Firebase ì„¤ì • ì˜¤ë¥˜',
        'Firebase ì„¤ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nFCM ì¸ì¦ì„œê°€ ì˜¬ë°”ë¥´ê²Œ ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.',
        [
          { text: 'ë¡œì»¬ ì•Œë¦¼ ì‚¬ìš©', onPress: () => setupLocalNotificationsOnly() },
          { text: 'í™•ì¸', style: 'cancel' }
        ]
      );
    } else if (error.message.includes('projectId')) {
      Alert.alert(
        'EAS ì„¤ì • ì˜¤ë¥˜',
        `í”„ë¡œì íŠ¸ ID ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\ní™•ì¸ëœ ID: ff8a3b71-7f94-41f0-9b5d-34df9484f5fc\n\në¡œì»¬ ì•Œë¦¼ì€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.`,
        [
          { text: 'ë¡œì»¬ ì•Œë¦¼ ì‚¬ìš©', onPress: () => setupLocalNotificationsOnly() },
          { text: 'í™•ì¸', style: 'cancel' }
        ]
      );
    } else if (isRetryableError) {
      Alert.alert(
        'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜',
        `í‘¸ì‹œ ì•Œë¦¼ ì„œë¹„ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n${MAX_RETRIES + 1}ë²ˆ ì‹œë„í–ˆì§€ë§Œ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\në„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`,
        [
          { text: 'ë¡œì»¬ ì•Œë¦¼ ì‚¬ìš©', onPress: () => setupLocalNotificationsOnly() },
          { text: 'ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„', style: 'cancel' }
        ]
      );
    } else {
      Alert.alert('ì•Œë¦¼ ë“±ë¡ ì‹¤íŒ¨', `ì˜¤ë¥˜: ${error.message}`);
    }

    return null;
  }
};

export const checkNetworkAndRetry = async () => {
  try {
    const netInfo = await NetInfo.fetch();
    console.log('ë„¤íŠ¸ì›Œí¬ ìƒíƒœ:', netInfo);

    if (!netInfo.isConnected) {
      Alert.alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      return false;
    }

    return true;
  } catch (error) {
    console.error('ë„¤íŠ¸ì›Œí¬ í™•ì¸ ì˜¤ë¥˜:', error);
    return true; // í™•ì¸ ì‹¤íŒ¨ì‹œ ê³„ì† ì§„í–‰
  }
};

export const scheduleRainNotification = async (hour, minute, weatherData) => {
  try {
    console.log('ì•Œë¦¼ ìŠ¤ì¼€ì¤„ ì‹œì‘:', { hour, minute });

    await Notifications.cancelAllScheduledNotificationsAsync();

    const rainProbability = weatherData?.daily?.precipitation_probability_max?.[0] || 0;
    const precipitation = weatherData?.daily?.precipitation_sum?.[0] || 0;
    const maxTemp = Math.round(weatherData?.daily?.temperature_2m_max?.[0] || 0);
    const minTemp = Math.round(weatherData?.daily?.temperature_2m_min?.[0] || 0);

    console.log('ë‚ ì”¨ ë°ì´í„°:', { rainProbability, precipitation, maxTemp, minTemp });

    if (rainProbability >= 30 && precipitation >= 0.1) {
      let umbrellaLevel = '';
      let precipitationText = '';
      let notificationPriority = Notifications.AndroidImportance.DEFAULT;

      if (rainProbability >= 70 && precipitation >= 5) {
        umbrellaLevel = 'ğŸŒ§ï¸ ê¼­ í•„ìš”';
        precipitationText = `ê°•í•œ ë¹„ ì˜ˆìƒ (${precipitation}mm)`;
        notificationPriority = Notifications.AndroidImportance.HIGH;
      } else if (rainProbability >= 50 && precipitation >= 1) {
        umbrellaLevel = 'â˜” ê¶Œì¥';
        precipitationText = `ë¹„ ì˜ˆìƒ (${precipitation}mm)`;
        notificationPriority = Notifications.AndroidImportance.DEFAULT;
      } else {
        umbrellaLevel = 'ğŸŒ¦ï¸ ê³ ë ¤';
        precipitationText = `ì•½í•œ ë¹„ ê°€ëŠ¥ (${precipitation}mm)`;
        notificationPriority = Notifications.AndroidImportance.DEFAULT;
      }

      const notificationBody = `${umbrellaLevel}\n${precipitationText}\nìµœê³  ${maxTemp}Â°C / ìµœì € ${minTemp}Â°C`;

      // ì‹œê°„ ìœ íš¨ì„± ê²€ì‚¬
      if (hour < 0 || hour > 23 || minute < 0 || minute > 59) {
        throw new Error('ì˜ëª»ëœ ì‹œê°„ í˜•ì‹ì…ë‹ˆë‹¤');
      }

      // ê¶Œí•œ ì¬í™•ì¸
      const { status } = await Notifications.getPermissionsAsync();
      if (status !== 'granted') {
        throw new Error('ì•Œë¦¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
      }

      const trigger = {
        hour,
        minute,
        repeats: true,
      };

      const notificationId = await Notifications.scheduleNotificationAsync({
        content: {
          title: 'ğŸŒ‚ ìš°ì‚° ì±™ê¸°ì„¸ìš”!',
          body: notificationBody,
          sound: true,
          priority: notificationPriority,
          data: {
            rainProbability,
            precipitation,
            maxTemp,
            minTemp,
            type: 'rain_notification'
          },
        },
        trigger,
      });

      console.log('ì•Œë¦¼ ìŠ¤ì¼€ì¤„ ì™„ë£Œ:', notificationId);
      return {
        success: true,
        message: `ë§¤ì¼ ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}ì— ë‚ ì”¨ ì•Œë¦¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤`,
        notificationId
      };
    }

    return {
      success: false,
      message: 'ë¹„ ì˜ˆë³´ê°€ ì—†ì–´ ì•Œë¦¼ì„ ì„¤ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'
    };
  } catch (error) {
    console.error('ì•Œë¦¼ ìŠ¤ì¼€ì¤„ ì˜¤ë¥˜:', error);
    throw new Error(`ì•Œë¦¼ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
  }
};

export const checkDailyWeatherAndNotify = async (weatherData, hour, minute) => {
  try {
    const result = await scheduleRainNotification(hour, minute, weatherData);
    return result;
  } catch (error) {
    console.error('ì¼ì¼ ë‚ ì”¨ ì²´í¬ ì˜¤ë¥˜:', error);
    return {
      success: false,
      message: `ë‚ ì”¨ ì²´í¬ ì‹¤íŒ¨: ${error.message}`
    };
  }
};

export const getUmbrellaRecommendation = (weatherData) => {
  const rainProbability = weatherData?.daily?.precipitation_probability_max?.[0] || 0;
  const precipitation = weatherData?.daily?.precipitation_sum?.[0] || 0;

  if (rainProbability >= 70 && precipitation >= 5) {
    return {
      level: 'high',
      message: `ğŸŒ§ï¸ ìš°ì‚° ê¼­ í•„ìš”! (ë¹„ í™•ë¥  ${rainProbability}%, ê°•ìˆ˜ëŸ‰ ${precipitation}mm)`
    };
  } else if (rainProbability >= 50 && precipitation >= 1) {
    return {
      level: 'medium',
      message: `â˜” ìš°ì‚° ê¶Œì¥. (ë¹„ í™•ë¥  ${rainProbability}%, ê°•ìˆ˜ëŸ‰ ${precipitation}mm)`
    };
  } else if (rainProbability >= 30 && precipitation >= 0.1) {
    return {
      level: 'low',
      message: `ğŸŒ¦ï¸ ìš°ì‚° ê³ ë ¤. (ë¹„ í™•ë¥  ${rainProbability}%, ê°•ìˆ˜ëŸ‰ ${precipitation}mm)`
    };
  }

  return {
    level: 'none',
    message: 'â˜€ï¸ ìš°ì‚° ë¶ˆí•„ìš”.'
  };
};

export const sendTestNotification = async () => {
  try {
    // ê¶Œí•œ í™•ì¸
    const { status } = await Notifications.getPermissionsAsync();
    if (status !== 'granted') {
      throw new Error('ì•Œë¦¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
    }

    await Notifications.scheduleNotificationAsync({
      content: {
        title: 'ğŸŒ‚ í…ŒìŠ¤íŠ¸ ì•Œë¦¼',
        body: 'ë¹„ í™•ë¥  80%, ê°•ìˆ˜ëŸ‰ 5.2mm\nìµœê³  23Â°C, ìµœì € 18Â°C',
        sound: true,
        priority: Notifications.AndroidImportance.HIGH,
      },
      trigger: null,
    });

    console.log('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ');
    return { success: true, message: 'í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤' };
  } catch (error) {
    console.error('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì˜¤ë¥˜:', error);
    throw new Error(`í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
  }
};

// ë¡œì»¬ ì•Œë¦¼ë§Œ ì‚¬ìš©í•˜ëŠ” ëŒ€ì•ˆ í•¨ìˆ˜
export const setupLocalNotificationsOnly = async () => {
  try {
    if (!Device.isDevice) {
      Alert.alert('ì•Œë¦¼ ì„¤ì • ì‹¤íŒ¨', 'ì‹¤ì œ ê¸°ê¸°ì—ì„œë§Œ ì•Œë¦¼ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      return false;
    }

    // Android ì•Œë¦¼ ì±„ë„ ì„¤ì •
    if (Platform.OS === 'android') {
      await Notifications.setNotificationChannelAsync('default', {
        name: 'default',
        importance: Notifications.AndroidImportance.MAX,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: '#FF231F7C',
      });
    }

    const { status } = await Notifications.requestPermissionsAsync();
    if (status !== 'granted') {
      Alert.alert('ê¶Œí•œ í•„ìš”', 'ì„¤ì •ì—ì„œ ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
      return false;
    }

    Alert.alert(
      'ì•Œë¦¼ ì„¤ì • ì™„ë£Œ',
      'ë¡œì»¬ ì•Œë¦¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâœ… ì˜ˆì•½ ì•Œë¦¼ ì‘ë™\nâœ… í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì‘ë™\nğŸ“± ì›ê²© í‘¸ì‹œëŠ” Firebase ì„¤ì • í›„ ê°€ëŠ¥'
    );

    return true;
  } catch (error) {
    console.error('ë¡œì»¬ ì•Œë¦¼ ì„¤ì • ì˜¤ë¥˜:', error);
    Alert.alert('ì„¤ì • ì‹¤íŒ¨', 'ì•Œë¦¼ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    return false;
  }
};
